<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana åœ°å€æ—¥äº¤æ˜“ç»Ÿè®¡å·¥å…· (å®æ—¶ç›‘æ§ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50 min-h-screen text-gray-800">

    <div class="max-w-4xl mx-auto py-12 px-4">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h1 class="text-2xl font-bold text-gray-900 mb-2 flex items-center">
                <span class="mr-2">ğŸ“Š</span> Solana åœ°å€å®æ—¶äº¤æ˜“ç»Ÿè®¡
                <span id="liveBadge"
                    class="ml-auto hidden text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full animate-pulse">â—
                    LIVE</span>
            </h1>
            <p class="text-sm text-gray-500 mb-6">æŠ“å–æœ€è¿‘ä¸¤å‘¨æ•°æ®ï¼Œå¹¶å®æ—¶ç›‘å¬æ–°å‘ç”Ÿçš„äº¤æ˜“ï¼ˆæ— éœ€åˆ·æ–°ï¼‰ã€‚</p>

            <div class="flex flex-col md:flex-row gap-3">
                <input type="text" id="addressInput" placeholder="è¯·è¾“å…¥ SOL é’±åŒ…åœ°å€..."
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none">
                <button onclick="fetchStats()" id="btnText"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 disabled:opacity-50">
                    å¼€å§‹åˆ†æ
                </button>
            </div>
            <p id="status" class="mt-3 text-sm text-purple-600 font-medium"></p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <canvas id="txChart" width="400" height="200"></canvas>
            <div id="emptyState" class="py-20 text-center text-gray-400">
                æš‚æ— æ•°æ®ï¼Œè¯·åœ¨ä¸Šæ–¹è¾“å…¥åœ°å€å¹¶ç‚¹å‡»åˆ†æ
            </div>
        </div>
    </div>

    <script>
        // åŸºç¡€ç¡¬é˜²å¾¡é€»è¾‘
        document.addEventListener('contextmenu', e => e.preventDefault(), false);
        document.addEventListener('keydown', e => {
            if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || (e.metaKey && e.altKey && e.key === 'I')) {
                e.preventDefault();
            }
        }, false);

        let myChart = null;
        let currentStats = {}; // å…¨å±€å­˜å‚¨ç»Ÿè®¡æ•°æ®
        let subscriptionId = null; // WebSocket è®¢é˜… ID

        async function fetchStats() {
            const address = document.getElementById('addressInput').value.trim();
            const btn = document.getElementById('btnText');
            const status = document.getElementById('status');
            const emptyState = document.getElementById('emptyState');
            const liveBadge = document.getElementById('liveBadge');

            if (!address) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ Solana åœ°å€");
                return;
            }

            const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=401bf178-3c34-4f65-a0d1-bfdbeb9d3899";
            const connection = new solanaWeb3.Connection(RPC_URL, 'confirmed');
            let pubKey = new solanaWeb3.PublicKey(address);

            // æ¸…ç†æ—§çš„è®¢é˜…
            if (subscriptionId !== null) {
                connection.removeOnLogsListener(subscriptionId);
                liveBadge.classList.add('hidden');
            }

            const TWO_WEEKS_AGO = Math.floor(Date.now() / 1000) - (14 * 24 * 60 * 60);

            btn.disabled = true;
            btn.innerText = "å†å²æŠ“å–ä¸­...";
            status.innerText = "æ­£åœ¨è·å–æœ€è¿‘ä¸¤å‘¨çš„å†å²æ•°æ®...";
            emptyState.style.display = "none";
            currentStats = {};

            let allSignatures = [];
            let lastSignature = null;
            let keepFetching = true;

            try {
                while (keepFetching) {
                    const signatures = await connection.getSignaturesForAddress(pubKey, { limit: 1000, before: lastSignature });
                    if (signatures.length === 0) break;

                    for (let sig of signatures) {
                        if (sig.blockTime < TWO_WEEKS_AGO) {
                            keepFetching = false;
                            break;
                        }
                        if (sig.err === null) {
                            const date = new Date(sig.blockTime * 1000).toLocaleDateString('zh-CN');
                            currentStats[date] = (currentStats[date] || 0) + 1;
                            allSignatures.push(sig);
                        }
                    }
                    lastSignature = signatures[signatures.length - 1].signature;
                    if (allSignatures.length > 10000) break;
                    status.innerText = `å·²è·å– ${allSignatures.length} ç¬”å†å²äº¤æ˜“...`;
                }

                // æ’åºå¹¶åˆå§‹æ¸²æŸ“
                renderChart();
                status.innerText = "å†å²ç»Ÿè®¡å®Œæˆï¼Œå·²å¼€å¯å®æ—¶ç›‘æ§ï¼";
                liveBadge.classList.remove('hidden');

                // --- å¼€å¯å®æ—¶ç›‘å¬é€»è¾‘ ---
                subscriptionId = connection.onLogs(pubKey, (logs) => {
                    if (logs.err === null) {
                        const today = new Date().toLocaleDateString('zh-CN');
                        currentStats[today] = (currentStats[today] || 0) + 1;
                        console.log("æ£€æµ‹åˆ°æ–°äº¤æ˜“ï¼", logs.signature);
                        renderChart(); // æ›´æ–°å›¾è¡¨
                    }
                }, 'confirmed');

            } catch (err) {
                status.innerText = "é”™è¯¯: " + err.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "å¼€å§‹åˆ†æ";
            }
        }

        function renderChart() {
            const ctx = document.getElementById('txChart').getContext('2d');

            // æ ¼å¼åŒ–æ•°æ®
            const chartData = Object.entries(currentStats)
                .map(([date, count]) => ({ date, count }))
                .sort((a, b) => new Date(a.date.replace(/\//g, '-')) - new Date(b.date.replace(/\//g, '-')));

            if (myChart) {
                myChart.data.labels = chartData.map(d => d.date);
                myChart.data.datasets[0].data = chartData.map(d => d.count);
                myChart.update('none'); // é™é»˜æ›´æ–°ï¼Œé˜²æ­¢æŸ±å­è·³åŠ¨
                return;
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [{
                        label: 'äº¤æ˜“ç¬”æ•°',
                        data: chartData.map(d => d.count),
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: 'rgb(139, 92, 246)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    },
                    animation: {
                        onComplete: function () {
                            const chartInstance = this;
                            const ctx = chartInstance.ctx;
                            ctx.font = 'bold 10px monospace';
                            ctx.fillStyle = "#7c3aed";
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';

                            this.data.datasets.forEach(function (dataset, i) {
                                const meta = chartInstance.getDatasetMeta(i);
                                meta.data.forEach(function (bar, index) {
                                    ctx.fillText(dataset.data[index], bar.x, bar.y - 5);
                                });
                            });
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>